#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
# –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "prisma/schema.prisma" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º"
    exit 1
fi

echo "üìä –¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DATABASE_URL"

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate status

# –®–∞–≥ 2: –ü–æ–º–µ—á–∞–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω—É—é
echo "üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ—É–¥–∞—á–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π..."
npx prisma migrate resolve --applied 20251011105336_init_clean_schema

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é reset-database.sh"
    exit 1
fi

# –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate deploy

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    exit 1
fi

# –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client
echo "üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."
npx prisma generate

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma Client"
    exit 1
fi

# –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ applications —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã applications..."
npx prisma db execute --stdin <<< "SELECT COUNT(*) FROM applications;" 2>/dev/null

if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ applications –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ..."
    npx prisma db execute --file prisma/init-data.sql --schema prisma/schema.prisma
else
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ applications —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –®–∞–≥ 6: –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
npm run build

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

echo "‚úÖ –ü—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!"
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!"
echo ""
echo "üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π:"
echo "   npm run start:prod"
