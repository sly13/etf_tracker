import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../../shared/prisma/prisma.service';
import { FirebaseAdminService } from '../notifications/firebase-admin.service';
import { TelegramBotService } from '../telegram-bot/telegram-bot.service';

export interface ETFNotificationSettings {
  minAmount: number; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö)
  enabledCompanies: string[]; // –ö–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  enabledAssets: ('bitcoin' | 'ethereum')[]; // –¢–∏–ø—ã –∞–∫—Ç–∏–≤–æ–≤
  notificationTypes: ('instant' | 'daily')[]; // –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  enabled: boolean; // –í–∫–ª—é—á–µ–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
}

@Injectable()
export class ETFNotificationService {
  private readonly logger = new Logger(ETFNotificationService.name);

  constructor(
    private prisma: PrismaService,
    private firebaseAdminService: FirebaseAdminService,
    private telegramBotService: TelegramBotService,
  ) {}

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getUserNotificationSettings(
    userId: string,
  ): Promise<ETFNotificationSettings> {
    try {
      const user = await this.prisma.user.findUnique({
        where: { id: userId },
        select: { settings: true },
      });

      if (!user?.settings) {
        return this.getDefaultSettings();
      }

      const settings = user.settings as any;
      return {
        minAmount: settings.etfNotifications?.minAmount || 1,
        enabledCompanies: settings.etfNotifications?.enabledCompanies || [
          'blackrock',
          'fidelity',
        ],
        enabledAssets: settings.etfNotifications?.enabledAssets || [
          'bitcoin',
          'ethereum',
        ],
        notificationTypes: settings.etfNotifications?.notificationTypes || [
          'instant',
        ],
        enabled: settings.etfNotifications?.enabled !== false,
      };
    } catch (error) {
      this.logger.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return this.getDefaultSettings();
    }
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async updateUserNotificationSettings(
    userId: string,
    settings: Partial<ETFNotificationSettings>,
  ): Promise<void> {
    try {
      const user = await this.prisma.user.findUnique({
        where: { id: userId },
        select: { settings: true },
      });

      const currentSettings = (user?.settings as any) || {};
      const etfSettings = currentSettings.etfNotifications || {};

      const updatedSettings = {
        ...currentSettings,
        etfNotifications: {
          ...etfSettings,
          ...settings,
        },
      };

      await this.prisma.user.update({
        where: { id: userId },
        data: { settings: updatedSettings },
      });

      this.logger.log(
        `–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`,
      );
    } catch (error) {
      this.logger.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      throw error;
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö ETF
   */
  async getUsersForETFNotifications(appName: string): Promise<any[]> {
    try {
      const users = await this.prisma.user.findMany({
        where: {
          application: { name: appName },
          isActive: true,
          deviceToken: { not: null as any },
          settings: {
            path: ['etfNotifications', 'enabled'],
            equals: true,
          },
        },
        select: {
          id: true,
          deviceToken: true,
          telegramChatId: true,
          settings: true,
        },
      });

      return users.filter((user) => {
        const settings = user.settings as any;
        return settings?.etfNotifications?.enabled !== false;
      });
    } catch (error) {
      this.logger.error(
        '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è ETF —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:',
        error,
      );
      return [];
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö ETF
   */
  async sendETFNotificationsForNewRecords(appName: string): Promise<void> {
    try {
      this.logger.log('üîî –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö ETF...');

      // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const newRecords = await this.prisma.eTFNewRecord.findMany({
        where: {
          deliveries: {
            none: {}, // –ó–∞–ø–∏—Å–∏ –±–µ–∑ –¥–æ—Å—Ç–∞–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
          },
        },
        orderBy: {
          detectedAt: 'desc',
        },
        take: 20, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      });

      if (newRecords.length === 0) {
        this.logger.log('üì≠ –ù–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
      }

      this.logger.log(
        `üìä –ù–∞–π–¥–µ–Ω–æ ${newRecords.length} –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`,
      );

      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const users = await this.getUsersForETFNotifications(appName);

      if (users.length === 0) {
        this.logger.log('üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
      }

      this.logger.log(
        `üë• –ù–∞–π–¥–µ–Ω–æ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`,
      );

      let totalSent = 0;
      let totalFailed = 0;

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
      for (const record of newRecords) {
        this.logger.log(
          `üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø–∏—Å—å: ${record.company} - ${record.amount}M ${record.assetType}`,
        );

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        for (const user of users) {
          try {
            const userSettings = await this.getUserNotificationSettings(
              user.id,
            );

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –∑–∞–ø–∏—Å—å –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!this.shouldNotifyUser(record, userSettings)) {
              continue;
            }

            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –¥–æ—Å—Ç–∞–≤–∫–µ
            const delivery = await this.prisma.eTFNotificationDelivery.create({
              data: {
                userId: user.id,
                recordId: record.id,
                sent: false,
                channel: 'push',
              },
            });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const title = this.formatNotificationTitle(record);
            const body = this.formatNotificationBody(record);

            await this.firebaseAdminService.sendNotificationToToken(
              user.deviceToken,
              title,
              body,
              {
                type: 'etf_new_record',
                recordId: record.id,
                assetType: record.assetType,
                company: record.company,
                amount: record.amount.toString(),
                date: record.date.toISOString(),
              },
            );

            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
            await this.prisma.eTFNotificationDelivery.update({
              where: { id: delivery.id },
              data: {
                sent: true,
                sentAt: new Date(),
              },
            });

            totalSent++;
            this.logger.log(
              `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.id}`,
            );

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å chatId
            if (user.telegramChatId) {
              try {
                await this.telegramBotService.sendTestMessage(
                  user.telegramChatId,
                  `${title}\n\n${body}`,
                );

                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ Telegram –¥–æ—Å—Ç–∞–≤–∫–µ
                await this.prisma.eTFNotificationDelivery.create({
                  data: {
                    userId: user.id,
                    recordId: record.id,
                    sent: true,
                    sentAt: new Date(),
                    channel: 'telegram',
                  },
                });

                this.logger.log(
                  `üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.id}`,
                );
              } catch (telegramError) {
                this.logger.error(
                  `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:`,
                  telegramError,
                );
              }
            }
          } catch (error) {
            totalFailed++;
            this.logger.error(
              `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.id}:`,
              error,
            );

            // –û—Ç–º–µ—á–∞–µ–º –æ—à–∏–±–∫—É –≤ –¥–æ—Å—Ç–∞–≤–∫–µ
            try {
              await this.prisma.eTFNotificationDelivery.updateMany({
                where: {
                  userId: user.id,
                  recordId: record.id,
                  sent: false,
                },
                data: {
                  error: error.message,
                },
              });
            } catch (updateError) {
              this.logger.error(
                '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:',
                updateError,
              );
            }
          }
        }
      }

      this.logger.log(
        `üéâ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${totalSent}, –û—à–∏–±–æ–∫: ${totalFailed}`,
      );
    } catch (error) {
      this.logger.error(
        '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö ETF:',
        error,
      );
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∑–∞–ø–∏—Å–∏
   */
  private shouldNotifyUser(
    record: any,
    settings: ETFNotificationSettings,
  ): boolean {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if (!settings.enabled) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É
    if (record.amount < settings.minAmount) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∞–∫—Ç–∏–≤–∞
    if (!settings.enabledAssets.includes(record.assetType)) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–ø–∞–Ω–∏—é
    if (!settings.enabledCompanies.includes(record.company)) {
      return false;
    }

    return true;
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   */
  private formatNotificationTitle(record: any): string {
    const companyName = this.getCompanyDisplayName(record.company);
    const assetName = record.assetType === 'bitcoin' ? 'Bitcoin' : 'Ethereum';
    const amount = Math.abs(record.amount).toFixed(1);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏—Ç–æ–∫–æ–º –∏–ª–∏ –æ—Ç—Ç–æ–∫–æ–º
    const isInflow = record.amount > 0;
    const sign = isInflow ? '+' : '-';
    const action = isInflow ? 'bought' : 'sold';

    return `üìä ${companyName} ${action} ${assetName} ETF for ${sign}${amount}M`;
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   */
  private formatNotificationBody(record: any): string {
    const assetName = record.assetType === 'bitcoin' ? 'Bitcoin' : 'Ethereum';

    return `${assetName} ETF`;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏
   */
  private getCompanyDisplayName(company: string): string {
    const companyNames: { [key: string]: string } = {
      blackrock: 'BlackRock',
      fidelity: 'Fidelity',
      bitwise: 'Bitwise',
      twentyOneShares: '21Shares',
      vanEck: 'VanEck',
      invesco: 'Invesco',
      franklin: 'Franklin Templeton',
      grayscale: 'Grayscale',
      grayscaleEth: 'Grayscale',
      grayscaleBtc: 'Grayscale',
      valkyrie: 'Valkyrie',
      wisdomTree: 'WisdomTree',
    };

    return companyNames[company] || company;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   */
  private getDefaultSettings(): ETFNotificationSettings {
    return {
      minAmount: 1,
      enabledCompanies: ['blackrock', 'fidelity'],
      enabledAssets: ['bitcoin', 'ethereum'],
      notificationTypes: ['instant'],
      enabled: true,
    };
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getUserNotificationStats(userId: string): Promise<{
    totalSent: number;
    totalFailed: number;
    lastNotification: Date | null;
  }> {
    try {
      const sentCount = await this.prisma.eTFNotificationDelivery.count({
        where: { userId, sent: true },
      });

      const failedCount = await this.prisma.eTFNotificationDelivery.count({
        where: { userId, sent: false },
      });

      const lastNotification =
        await this.prisma.eTFNotificationDelivery.findFirst({
          where: { userId, sent: true },
          orderBy: { sentAt: 'desc' },
          select: { sentAt: true },
        });

      return {
        totalSent: sentCount,
        totalFailed: failedCount,
        lastNotification: lastNotification?.sentAt || null,
      };
    } catch (error) {
      this.logger.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return {
        totalSent: 0,
        totalFailed: 0,
        lastNotification: null,
      };
    }
  }
}
