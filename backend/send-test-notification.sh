#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./send-test-notification.sh <FCM_TOKEN>

FCM_TOKEN=$1
BACKEND_URL="https://api-etf.vadimsemenko.ru"

if [ -z "$FCM_TOKEN" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: FCM —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω"
  echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./send-test-notification.sh <FCM_TOKEN>"
  echo ""
  echo "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å FCM —Ç–æ–∫–µ–Ω:"
  echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ"
  echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
  echo "3. –ù–∞–π–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö —Å—Ç—Ä–æ–∫—É: üîë FCM Token: ..."
  exit 1
fi

echo "üì± –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."
echo "üîë FCM Token: ${FCM_TOKEN:0:20}..."
echo ""

RESPONSE=$(curl -s -X POST "${BACKEND_URL}/api/notifications/test-token" \
  -H "Content-Type: application/json" \
  -d "{
    \"token\": \"$FCM_TOKEN\",
    \"title\": \"–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\",
    \"body\": \"–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä–µ\"
  }")

echo "üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
echo ""

if echo "$RESPONSE" | grep -q '"success":true'; then
  echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!"
else
  echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
fi


